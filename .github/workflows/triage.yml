name: Triage

on:
  # Trigger on new issues
  issues:
    types: [opened, labeled]

  # Manual trigger for triage commands
  workflow_dispatch:
    inputs:
      command:
        description: 'Triage command to run'
        required: true
        type: choice
        options:
          - assess
          - sprint
          - roadmap
          - security
          - cascade
        default: sprint
      issue:
        description: 'Issue number (for assess command)'
        required: false

concurrency:
  group: triage-${{ github.event_name }}-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  GH_TOKEN: ${{ secrets.CI_GITHUB_TOKEN }}
  OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}

jobs:
  # ============================================
  # ISSUE TRIAGE: Assess and label new issues
  # ============================================
  assess-issue:
    name: Assess Issue
    if: |
      github.event_name == 'issues' && github.event.action == 'opened' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'assess')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Assess issue
        run: |
          ISSUE_NUM="${{ github.event.issue.number || github.event.inputs.issue }}"
          if [ -n "$ISSUE_NUM" ]; then
            pnpm run triage assess "$ISSUE_NUM"
          else
            echo "No issue number provided"
            exit 1
          fi

  # ============================================
  # SPRINT PLANNING
  # ============================================
  sprint:
    name: Sprint Planning
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'sprint'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run sprint planning
        run: pnpm run triage sprint

  # ============================================
  # ROADMAP
  # ============================================
  roadmap:
    name: Generate Roadmap
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'roadmap'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate roadmap
        run: pnpm run triage roadmap

  # ============================================
  # SECURITY
  # ============================================
  security:
    name: Security Scan
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'security'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security scan
        run: pnpm run triage security

  # ============================================
  # CASCADE
  # ============================================
  cascade:
    name: Cascade Automation
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.command == 'cascade'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '22'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run cascade
        run: pnpm run triage cascade
