# Issue Triage Workflow
# Automatically triages issues using AI assessment and can trigger Issue-to-PR workflow
name: Issue Triage

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read
  models: read
  pull-requests: write

jobs:
  # AI Assessment job - runs when triage labels are applied
  ai-assessment:
    if: >-
      github.event.action == 'labeled' && 
      contains(fromJson('["needs-triage", "bug", "enhancement", "feature"]'), github.event.label.name)
    runs-on: ubuntu-latest
    outputs:
      ready_for_aider: ${{ steps.check-ready.outputs.ready }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: '20'

      - name: Run AI Assessment
        id: ai-assessment
        uses: github/ai-assessment-comment-labeler@e3bedc38cfffa9179fe4cee8f7ecc93bffb3fee7 # v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ai_review_label: ${{ github.event.label.name }}
          issue_number: ${{ github.event.issue.number }}
          issue_body: ${{ github.event.issue.body }}
          prompts_directory: '.github/prompts'
          labels_to_prompts_mapping: 'needs-triage,triage.prompt.yml|bug,bug-review.prompt.yml|enhancement,feature-review.prompt.yml|feature,feature-review.prompt.yml'
          model: 'openai/gpt-4.1'
          max_tokens: 500
          assessment_regex_pattern: '^###.*[aA]ssessment:\s*(.+)$'
          no_comment_regex_pattern: '<!--.*no.*comment.*-->'
          no_comment_regex_flags: 'i'

      - name: Check if ready for Aider
        id: check-ready
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const assessments = '${{ steps.ai-assessment.outputs.ai_assessments }}';
            let ready = false;
            
            try {
              const parsed = JSON.parse(assessments || '[]');
              for (const assessment of parsed) {
                if (assessment.response && assessment.response.includes('<!-- ready-for-aider -->')) {
                  ready = true;
                  console.log('Issue is ready for automated development');
                  break;
                }
              }
            } catch (e) {
              console.error('Failed to parse assessments:', e);
            }
            
            core.setOutput('ready', ready ? 'true' : 'false');
            return ready;

      - name: Add ready-for-aider label
        if: steps.check-ready.outputs.ready == 'true'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              labels: ['ready-for-aider']
            });
            console.log('Added ready-for-aider label');

  # Auto-triage new issues
  auto-triage:
    if: github.event.action == 'opened'
    runs-on: ubuntu-latest
    steps:
      - name: Add triage label to new issues
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            
            // Don't add triage label if issue already has specific labels
            const skipLabels = ['bug', 'enhancement', 'feature', 'documentation', 'question'];
            const hasSpecificLabel = labels.some(l => skipLabels.includes(l));
            
            if (!hasSpecificLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-triage']
              });
              console.log('Added needs-triage label to new issue');
            }

  # Trigger Issue-to-PR workflow when ready-for-aider label is applied
  trigger-issue-to-pr:
    if: github.event.action == 'labeled' && github.event.label.name == 'ready-for-aider'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Issue-to-PR workflow
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            console.log('Triggering Issue-to-PR workflow for issue #${{ github.event.issue.number }}');
            
            // Get default branch
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // Dispatch workflow
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'issue-to-pr-trigger.yml',
              ref: repo.default_branch,
              inputs: {
                'issue-number': '${{ github.event.issue.number }}',
                'base-branch': repo.default_branch
              }
            });
            
            // Add comment to issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: 'ðŸ¤– **Automated Development Started**\n\nThis issue has been identified as ready for automated development. The Issue-to-PR workflow has been triggered and will create a pull request with proposed changes.\n\nPlease review the resulting PR carefully when it\'s ready.'
            });
